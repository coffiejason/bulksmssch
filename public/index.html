
<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" type="text/css" href="css/progressbar.css">
    <link rel="stylesheet" type="text/css" href="css/modal.css">
    <link rel="stylesheet" type="text/css" href="css/input.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <meta charset="utf-8">
    
<meta name="viewport" content="width=device-width, initial-scale=1">

  </head>

  <body>
    <div class="file-upload" style="margin-top: 40%;">
      <div class="file-upload-select">
        <div class="file-select-button" >Choose File</div>
        <div class="file-select-name">No file chosen...</div> 
        <input type="file" accept=".csv" name="file-upload-input" id="file-upload-input">
      </div>
    </div>
    
        
    <br><img id="myImg" style="width: 100px; margin-top: 10px; display: none;" src="#">

    <progress class="pure-material-progress-circular" id="progressbar" style="margin-top: 2%; width: 40px; height: 40px; display: none;"></progress>
    <div id="upload_div" style="display: none;" onclick="uploadImg()">
      <img src="images/photo.png" style="width: 50px; margin: 1%;"/>
    </div>
    <script>

      let fileInput = document.getElementById("file-upload-input");
      let fileSelect = document.getElementsByClassName("file-upload-select")[0];
      fileSelect.onclick = function() {
        fileInput.click();
      }
      fileInput.onchange = function() {
        let filename = fileInput.files[0].name;
        let selectName = document.getElementsByClassName("file-select-name")[0];
        selectName.innerText = filename;
      }

      window.addEventListener('load', function() {
    
        document.querySelector('input[type="file"]').addEventListener('change', function() {
            if (this.files && this.files[0]) {
                var img = document.querySelector('img');
                img.onload = () => {
                    //URL.revokeObjectURL(img.src);  // no longer needed, free memory
                }

                //img.src = URL.createObjectURL(this.files[0]); // set src to blob url
                img.src = 'img/logo.jpg';
                //console.log(img.src)
                
                /*
                var x = document.getElementById("myImg");
                if (x.style.display === "none") {
                  x.style.display = "block";
                }

               var x = document.getElementById("upload_div");
                if (x.style.display === "none") {
                  x.style.display = "block";
                }*/

                uploadImg();
            }
        });
      });

      function uploadImg(){
        url = document.querySelector('img').src
        fileInput = document.querySelector('input[type="file"]');

        var x = document.getElementById("progressbar");
            if (x.style.display === "none") {
              x.style.display = "block";
        }

        var x = document.getElementById("upload_div");
            if (x.style.display === "block") {
              x.style.display = "none";
        }

          var data = new FormData();
          data.append("file", fileInput.files[0]);
          data.append("id", "test");
          
          var xhr = new XMLHttpRequest();
          xhr.withCredentials = true;

          xhr.addEventListener("readystatechange", function() {
            if(this.readyState === 4) {
              console.log(this.responseText);

            var x = document.getElementById("progressbar");
            if (x.style.display === "block") {
              x.style.display = "none";
            }

            alert('upload complete');
            }
            
            /*
            var x = document.getElementById("progressbar");
            if (x.style.display === "block") {
              x.style.display = "none";
            }*/

            //alert('upload complete');
          });

          xhr.open("POST", "https://bulksmssch.herokuapp.com/bulksms");

          xhr.send(data);

        /*
        if(url.search('blob:') == 0){

        }
        else{
          alert('Take a picture first')
        }*/
      }

      function submitResponse(){
        var textResponse = document.getElementById("textResponse").value;

        if(textResponse.length == 0){
                var x = document.getElementById("response_isrequired");
                if (x.style.display === "none") {
                  x.style.display = "block";
                }
        }
        else{

          var x = document.getElementById("response_isrequired");
          if (x.style.display === "block") {
            x.style.display = "none";
          }

          var xhr = new XMLHttpRequest();
          xhr.open("POST", "https://ispylegon.herokuapp.com/postResponse", true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.responseType = 'json';

          xhr.onload  = function() {
            var jsonResponse = xhr.response;
            location.href = "task.html?taskid="+taskid;
          };

          xhr.send(JSON.stringify({
              taskid: taskid,
              textResponse: textResponse,
              icsid: icsid
          }));

        }
      }
      
      //getModal();

      function getModal(){
        // Get the modal
        //var modal = document.getElementById("myModal");

        // Get the image and insert it inside the modal - use its "alt" text as a caption
        var img = document.getElementById("response_proof");
        var modalImg = document.getElementById("img01");
        var captionText = document.getElementById("caption");
        /*
        img.onclick = function(){
          modal.style.display = "block";
          modalImg.src = this.src;
          captionText.innerHTML = this.alt;
        }*/

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() { 
          modal.style.display = "none";
        }
      }

    </script>


    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->

    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-analytics.js"></script>
      
    <script src="js/firebase.js"></script>
  </body>

</html>
